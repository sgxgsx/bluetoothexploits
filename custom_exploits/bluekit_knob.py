import argparse
import logging
import subprocess
import time

from bluekit.report import report_not_vulnerable, report_vulnerable, report_error
from bluekit.recon import Recon
from bluekit.constants import LOG_FILE

logging.basicConfig(filename=LOG_FILE, level=logging.INFO)


def check_for_CVE_2018(target, directory, attempt=0):
    proc = subprocess.Popen('./bin/bt_exploiter --host-port=/dev/ttyUSB1 --exploit=knob --random_bdaddress --target={}'.format(target), stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True)
    output, err = proc.waite(timeout=40)
    
    time.sleep(1)
    try:
        mm = re.compile(b'KNOB is detected')
        
        output = mm.search(data).group()
        
    except Exception as e:
        logging.info("bluekit_knob -> error -> " + str(e))
        report_error("error - " + str(e))


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-t','--target',required=False, type=str, help="target MAC address")
    args = parser.parse_args()

    if args.target:
        check_CVE_2018(target=args.target)
    else:
        parser.print_help()
